import{n as r,bK as o}from"./index-FdyGBlLz.js";const c={props:{entityId:{type:[Number,void 0],default:void 0},isPower:{type:Boolean,default:!1},treeData:{type:Array,default:()=>[]},allList:{type:Array,default:()=>[]},checkTopicList:{type:Array,default:()=>[]}},data(){return{visible:!1,treeLoading:!1,tableLoading:!1,treeCheck:[],treeSelect:void 0,tableData:[],tableSource:[],partsDict:[],selectedRows:[],needCopy:!1,submitLoading:!1,filterKeys:[]}},computed:{tableHead(){return[{title:"排序",width:65,align:"center",customRender:(t,e,s)=>1+s},{title:"设备/部件名称",dataIndex:"entityCode",filters:this.partsDict},{title:"测点编号",dataIndex:"pointId"},{title:"测点短编号",dataIndex:"shortId"},{title:"测点名称",dataIndex:"name"}]},currSelectRows(){return this.needCopy?this.treeSelect&&this.treeCheck.length?this.treeCheck.includes(this.treeSelect)?this.selectedRows:[]:[]:this.getCurrList()},selectedRowKeys(){return this.selectedRows.map(t=>t.pointId)},selectedNames(){return this.selectedRows.map(t=>t.name).join("，")},selectedNameGroup(){let t=[];if(this.needCopy){let e=this.treeCheck.length;t.push({fanList:[`共${e}台风机`],points:e?this.selectedRows.map(s=>s.name):[]})}else{let e=[];this.selectedRows.forEach(s=>{e.includes(s.fanEntityId)||e.push(s.fanEntityId)}),e.forEach(s=>{let i=this.selectedRows.filter(a=>a.fanEntityId===s);t.push({fanList:[i[0].fanName],points:i.map(a=>a.name)})})}return t},currSelectRowKeys(){return this.currSelectRows.map(t=>t.pointId)},checkboxStat(){let t=!!this.treeCheck.length&&this.treeCheck.length<this.filterFanList.length,e=this.treeCheck.length===this.filterFanList.length;return{indeterminate:t,checked:e}},fanTypes(){let t=[],e=!1;this.treeData.forEach(i=>{i.equipment===""?e=!0:t.includes(i.equipment)||t.push(i.equipment)});let s=t.map(i=>({label:i,value:i}));return e&&s.push({label:"其它",value:""}),s},filterFanList(){let t=this.filterKeys;return t.length?this.treeData.filter(e=>t.includes(e.equipment)):this.treeData}},methods:{init(){this.visible=!0,this.treeCheck=[...new Set(this.checkTopicList.map(t=>t.fanEntityId))],this.isPower||(this.selectedRows=this.checkTopicList)},async getParts(t){return new Promise(e=>{o({entityId:t,simple:!0}).then(({result:s})=>{e(s)})})},async loadGather([t],e){if(!this.isPower&&e.selected){this.tableData=[],this.tableLoading=!0,this.treeSelect=t;let s=this.findPoints(e.node.dataRef.topicName),i=await this.getParts(t),a=e.node.dataRef.code,n={[t]:a};this.partsDict=[{text:a,value:a}],i.forEach(l=>{n[l.entityId]=l.code,this.partsDict.push({text:l.code,value:l.code})}),this.tableSource=s.map(l=>({...l,fanName:a,fanEntityId:t,entityCode:n[l.entityId]})),this.tableData=this.tableSource,this.tableLoading=!1}},onSelectChange(t){let e=this.needCopy?this.selectedRowKeys.indexOf(t.pointId):this.selectedRows.findIndex(s=>s.standpointId===t.standpointId);e!==-1?this.selectedRows.splice(e,1):this.selectedRows.push(t)},rowFn(t){return{on:{click:()=>{this.onSelectChange(t)}}}},handleTableChange(t,e){e.entityCode.length?this.tableData=this.tableSource.filter(s=>e.entityCode.includes(s.entityCode)):this.tableData=this.tableSource},checkAll(t){t.target.checked?this.treeCheck=this.filterFanList.map(e=>e.key):(this.treeCheck=[],this.needCopy&&(this.selectedRows=[]))},needCopyChange(t){t?this.selectedRows=this.getCurrList():this.selectedRows=this.tableData.filter(e=>this.selectedRowKeys.includes(e.pointId))},getPointsLen(t){return this.needCopy?this.treeCheck.includes(t.key)?this.selectedRowKeys.length:0:this.getCurrList(t.key).length},getCurrList(t=this.treeSelect){return this.selectedRows.filter(e=>e.fanEntityId===t)},findPoints(t=""){return this.allList.filter(e=>e.fanTopicName===t)},close(){this.visible=!1,this.reset()},reset(t=!1){this.treeCheck=[],this.treeSelect=void 0,this.tableData=[],this.tableSource=[],this.partsDict=[],this.selectedRows=[],this.needCopy=!1,this.$parent.comProps=null,this.$parent.yAxis=[],t&&this.$emit("submit",[])},async submit(){let t=[];if(this.isPower)t=this.treeCheck.length?this.allList.filter(e=>this.treeCheck.includes(e.entityId)&&(e.pointId==="wind-speed"||e.pointId==="wind-power")):[];else if(this.needCopy){let e=this.selectedRows.map(s=>s.pointId);this.treeCheck.forEach(s=>{let{topicName:i}=this.treeData.find(a=>a.key===s)||{};if(i){let n=(this.findPoints(i)||[]).filter(l=>e.includes(l.pointId));t=[...t,...n]}})}else t=this.selectedRows;this.$emit("submit",JSON.parse(JSON.stringify(t))),this.close()}}};var h=function(){var e=this,s=e._self._c;return s("a-modal",{staticClass:"blackModal pModal",attrs:{visible:e.visible,width:"1300px",dialogClass:"paramModal",title:"测点选择",maskClosable:!1,keyboard:!1,destroyOnClose:"",confirmLoading:e.submitLoading,closable:!1}},[s("a-row",[s("a-col",{attrs:{span:5}},[s("div",{staticStyle:{display:"flex","justify-content":"space-between","align-items":"center","padding-right":"10px"}},[s("a-checkbox",e._b({directives:[{name:"show",rawName:"v-show",value:e.treeData.length,expression:"treeData.length"}],staticClass:"tree-checkbox",on:{change:e.checkAll}},"a-checkbox",e.checkboxStat,!1),[e._v(" 风机机组 ")]),s("a-select",{directives:[{name:"show",rawName:"v-show",value:e.treeData.length,expression:"treeData.length"}],staticClass:"pm-pick-select",attrs:{mode:"multiple",placeholder:"机型筛选"},on:{change:function(i){e.treeCheck=[]}},model:{value:e.filterKeys,callback:function(i){e.filterKeys=i},expression:"filterKeys"}},e._l(e.fanTypes,function(i){return s("a-select-option",{key:i.value,attrs:{value:i.value}},[e._v(" "+e._s(i.label)+" ")])}),1)],1),s("a-spin",{attrs:{tip:"树数据加载中...",spinning:e.treeLoading,wrapperClassName:"pm-spin"}},[s("div",{staticClass:"tree-content"},[s("a-tree",{attrs:{checkable:"",treeData:e.filterFanList,selectedKeys:[e.treeSelect]},on:{select:e.loadGather},scopedSlots:e._u([{key:"title",fn:function(i){return[e._v(" "+e._s(i.title)),e.getPointsLen(i)?[e._v(" ["),s("span",{staticClass:"points-number"},[e._v(e._s(e.getPointsLen(i)))]),e._v("] ")]:e._e()]}}]),model:{value:e.treeCheck,callback:function(i){e.treeCheck=i},expression:"treeCheck"}})],1)])],1),s("a-col",{directives:[{name:"show",rawName:"v-show",value:!e.isPower,expression:"!isPower"}],attrs:{span:19}},[s("a-checkbox",{staticClass:"table-checkbox",on:{input:e.needCopyChange},model:{value:e.needCopy,callback:function(i){e.needCopy=i},expression:"needCopy"}},[e._v(" 复制测点到所选中的风机 ")]),s("a-tooltip",{attrs:{title:"当勾选时，将使用当前风机所选中的测点复制到选中的风机；当取消勾选时，将移除掉其它风机的测点，仅保留当前。"}},[s("a-icon",{attrs:{type:"question-circle"}})],1),s("a-tooltip",{attrs:{placement:"bottom",overlayStyle:{maxWidth:"980px"}}},[s("template",{slot:"title"},e._l(e.selectedNameGroup,function(i,a){return s("div",{key:a},[s("span",[e._v(e._s(i.fanList.toString())+"：")]),s("span",[e._v("【"+e._s(i.points.join("、"))+"】")])])}),0),s("a-alert",{staticClass:"pm-alert",attrs:{"show-icon":"",type:"info",message:"已选择测点："+e.selectedNames}})],2),s("a-table",{staticClass:"pm-table",attrs:{size:"small",rowKey:"pointId",dataSource:e.tableData,columns:e.tableHead,scroll:{y:440},pagination:!1,loading:e.tableLoading,"row-selection":{columnWidth:35,selectedRowKeys:e.currSelectRowKeys,onSelect:e.onSelectChange},customRow:e.rowFn},on:{change:e.handleTableChange}})],1)],1),s("template",{slot:"footer"},[s("a-button",{attrs:{ghost:""},on:{click:function(i){e.visible=!1,e.reset(!0)}}},[e._v("取消")]),s("a-button",{attrs:{type:"primary",ghost:""},on:{click:function(i){return e.reset(!0)}}},[e._v("清空")]),s("a-button",{attrs:{type:"primary"},on:{click:e.submit}},[e._v("完成")])],1)],2)},d=[],p=r(c,h,d,!1,null,"b734d718");const f=p.exports;export{f as default};
