import{n as C,j as m,ct as I,bX as _,cp as b,bL as P}from"./index-FdyGBlLz.js";import{b as f,e as T}from"./common-0X47MWYd.js";import{g as x}from"./store-BeJ4ml9q.js";const Y={props:{parentId:{type:String,default:""},entityInfo:{type:Object,default:()=>{}},judgeCondition:{type:Array,default:()=>[]},selectItem:{type:Object,default:()=>{}}},data(){return{lastUpdateTime:"",prevDataParams:{span:2,spanType:2,startTime:null,stopTime:null,pointId:"",topic:""},prevDataDateLoading:!0,pointsData:[],spanList:[1,2,5,10,20,30,60,120],currPointId:""}},computed:{splitLine(){return{show:!0,lineStyle:{color:"#183574",width:1,type:"dashed"},pointDetail:null}},color(){return this.selectItem.alarmLevel==="停机"?"#FF0000":"#FF8A00"},echartsOptions(){let e=[],t=this.alarmCondition.find(n=>n.judgeCondition.includes("<")),a=this.alarmCondition.find(n=>n.judgeCondition.includes(">")),i=this.alarmCondition.some(n=>n.linkSign==="&&");if(t&&a&&i){let n=Number(t.value);Number(a.value)<n&&(e=this.alarmCondition.filter(l=>JSON.stringify(l)!==JSON.stringify(t)))}e.length===0&&(e=this.alarmCondition);let o=[],p={},r=[],c=(this.pointsData[this.pointsData.length-1]||{}).utcTime;for(let n=0;n<e.length;n++){let s=e[n];if(["== null","!= null","=="].includes(s.itemValue))continue;s.value=Number(s.value);let l=null;s.linkSign==="&&"&&e[n+1]&&(l=Number(e[n+1].value),e[n+1].hasAdd=!0),s.hasAdd||s.judgeCondition==="=="||(s.judgeCondition===">"?o.push({gt:s.value,lt:l||(s.value>=0?99999:-99999),color:this.color}):s.judgeCondition===">="?o.push({gte:s.value,lt:l||(s.value>=0?99999:-99999),color:this.color}):s.judgeCondition==="<"?o.push({gt:l||(s.value>=0?0:-99999),lt:s.value,color:this.color}):s.judgeCondition==="<="?o.push({gt:l||(s.value>=0?0:-99999),lte:s.value,color:this.color}):o.push({value:s.value,color:"#1890FF"}));let y=this.judgeCondition.find(v=>v.itemValue===s.judgeCondition),d=this;r.push({yAxis:s.value,label:{color:"#FFF",formatter(v){let h=y.itemText;return h.includes("小于")?h=d.selectItem.alarmLevel+"下限值":h.includes("大于")&&(h=d.selectItem.alarmLevel+"上限值"),`${h}${v.value}${d.pointDetail&&d.pointDetail.clunit||""}`}}})}let u=this.pointsData.filter(n=>{var s,l;return n.utcTime>=new Date(this.selectItem.startTime).getTime()&&n.utcTime<=((s=this.selectItem)!=null&&s.endTime?new Date((l=this.selectItem)==null?void 0:l.endTime).getTime():c)}),D=this.alarmCondition.filter(n=>n.judgeCondition==="----"),g=[];return D.length?g=this.getUnchangedData(u):g=[],p={name:"数据",type:"line",smooth:!0,showSymbol:!1,hoverAnimation:!1,data:D.length?g:[],lineStyle:{color:"#FF0000"},large:!0,z:20},{tooltip:{trigger:"axis",backgroundColor:"#1C256A",borderColor:"#00DFFA",extraCssText:"box-shadow: inset 0px 0px 8px #00DFFA;",borderWidth:1,textStyle:{color:"#fff",lineHeight:200,height:200},formatter:([n])=>{let s=`${m(parseInt(n.name)).format("YYYY-MM-DD HH:mm:ss")}`;return n.value[1]&&(s+=`<br/>${this.currPointName}：${n.value[1]||""}( ${this.pointDetail&&this.pointDetail.clunit||""} )`),s},axisPointer:{animation:!1}},xAxis:{type:"time",splitLine:this.splitLine,axisLine:{lineStyle:{color:"#FFF"}}},visualMap:{type:"piecewise",show:!1,dimension:1,pieces:o,outOfRange:{color:"#1890FF"}},yAxis:{type:"value",splitLine:this.splitLine,name:`单位（ ${this.pointDetail&&this.pointDetail.clunit||""} ）`,nameLocation:"end",nameTextStyle:{align:"center"},axisLine:{lineStyle:{color:"#FFF"}}},dataZoom:[{type:"inside",start:0,end:100,xAxisIndex:0},{start:0,end:100}],series:[{name:"数据",type:"line",markLine:{silent:!0,lineStyle:{color:this.color},data:D.length?[]:r},smooth:!0,showSymbol:!1,hoverAnimation:!1,data:[],large:!0,emphasis:{disabled:!0},z:2},{...p}]}},alarmCondition(){return this.selectItem.alarmConditionList||[]},selectOpts(){return this.alarmCondition.map(e=>({label:e.paramName,title:e.paramName,value:`${e.equipmentTopicName}.${e.param}`}))},topic(){let{equipmentTopicName:e,param:t}=this.alarmCondition[0]||{},a=((e||"").split("/")||[]).pop();return{topicName:e,pointId:t,entityId:a}},currPointName(){let e=this.selectOpts.find(t=>t.value===this.currPointId);return e?e.title:""}},created(){this.initPointId()},mounted(){this._GetLastTime(),this.getPointDetail()},methods:{moment:m,initPointId(){this.currPointId=`${this.topic.topicName}.${this.topic.pointId}`},_GetLastTime(){let e={topicPointIds:this.currPointId};I(e).then(t=>{if(t.success){this.lastUpdateTime=t.result[e.topicPointIds]||"";let a=m(this.selectItem.startTime).format("YYYY-MM-DD")+" 00:00:00",i=m(this.selectItem.endTime||new Date).format("YYYY-MM-DD")+" 23:59:59";this.prevDataParams.startTime=a,this.prevDataParams.stopTime=i,this.prevDataParams.topic=e.topicPointIds,this.prevDataDateLoading=!1,this.loadPrevData()}})},getPointDetail(){_({entityId:this.topic.entityId,pageSize:1,pageNo:1,pointId:this.topic.pointId}).then(e=>{this.pointDetail=e.result.records[0]})},prevDataDateChange([e,t]){let a;m(t).isSame(new Date,"day")?a=m().format("YYYY-MM-DD HH:mm:ss"):a=m(t).add(1,"days").format("YYYY-MM-DD");let i={startTime:m(e).format("YYYY-MM-DD"),stopTime:a};this.loadPrevData(i)},_GetPointsData(e){return new Promise(t=>{let{startTime:a,stopTime:i,span:o,spanType:p}=e||{},r={startTime:a,stopTime:i,span:o,spanType:p},c={topicPointIds:this.prevDataParams.topic,...r};b(c).then(u=>{u.success&&t(u.result)})})},async loadPrevData(e){let t=await this._GetPointsData(Object.assign({},this.prevDataParams,e||{})),a=this.selectItem.endTime?new Date(this.selectItem.endTime).getTime():new Date().getTime(),i=[];a-new Date(this.selectItem.startTime).getTime()<1e3*60*60*24&&(i=await this._GetPointsData(Object.assign({},this.prevDataParams,{spanType:1,span:1,startTime:this.selectItem.startTime,stopTime:m(a).format("YYYY-MM-DD HH:mm:ss")})));for(let p in t){let r=t[p];r=r.concat((i==null?void 0:i[p])||[]).sort((c,u)=>c.utcTime-u.utcTime),this.pointsData=r,this.echartsOptions.series[0].data=r.map(({utcTime:c,value:u}={})=>({name:c,value:[f(new Date(c),1),this.keepDecimal(u)]})),this.$nextTick(()=>{this.initCharts()})}},initCharts(){this.$echarts.init(document.getElementById("line_echarts_points")).setOption(this.echartsOptions)},keepDecimal(e,t=4){return T(e)==="string"&&e!==""?+e?+(+e).toFixed(t):e:T(e)==="number"&&e!==0?+e.toFixed(t):e},getUnchangedData(e){let t=[],a=[];for(let i=0;i<e.length-1;i++)this.keepDecimal(e[i].value)===this.keepDecimal(e[i+1].value)?(t.length?(this.keepDecimal(t.lastItem.value)===this.keepDecimal(e[i].value)&&t.push({name:e[i].utcTime-1,value:[null,null]}),t.push({name:e[i].utcTime,value:[f(new Date(e[i].utcTime),1),this.keepDecimal(e[i].value)]})):t.push({name:e[i].utcTime,value:[f(new Date(e[i].utcTime),1),this.keepDecimal(e[i].value)]}),a.includes(e[i].value)||a.push(this.keepDecimal(e[i].value))):i>1&&this.keepDecimal(e[i].value)===this.keepDecimal(e[i-1].value)&&(t.push({name:e[i].utcTime,value:[f(new Date(e[i].utcTime),1),this.keepDecimal(e[i].value)]}),t.push({name:e[i].utcTime+1,value:[null,null]}),a.includes(e[i].value)||a.push(this.keepDecimal(e[i].value)));return t}}};var w=function(){var t=this,a=t._self._c;return a("div",{staticClass:"line_echarts"},[a("div",{staticClass:"chartsBox"},[t.lastUpdateTime?[a("p",{staticStyle:{"margin-bottom":"20px"}},[t._v("数据最后采集时间为："+t._s(t.lastUpdateTime))]),a("div",{ref:"calendarBox",staticClass:"calendarBox"}),a("a-form",{staticClass:"ga-form",attrs:{"label-col":{span:4},"wrapper-col":{span:15},layout:"inline",labelAlign:"right"}},[t.prevDataDateLoading?t._e():a("a-form-item",{staticStyle:{width:"50%"},attrs:{label:"时间范围"}},[a("a-range-picker",{staticClass:"ga-selectRange",attrs:{allowClear:!1,dropdownClassName:"blackDateBox",getCalendarContainer:()=>t.$refs.calendarBox,disabledDate:i=>i&&i>t.moment(),"default-value":[t.moment(t.prevDataParams.startTime,"YYYY-MM-DD"),t.moment(t.prevDataParams.stopTime,"YYYY-MM-DD")]},on:{change:t.prevDataDateChange}})],1),t.selectOpts.length>1?a("a-form-item",{staticStyle:{width:"40%"},attrs:{label:"测点"}},[a("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择测点",dropdownClassName:"ga-select",getPopupContainer:i=>i.parentNode},on:{change:t._GetLastTime},model:{value:t.currPointId,callback:function(i){t.currPointId=i},expression:"currPointId"}},t._l(t.selectOpts,function(i){return a("a-select-option",{key:i.value},[t._v(" "+t._s(i.label)+" ")])}),1)],1):t._e()],1),a("div",{staticClass:"line_echarts_points",attrs:{id:"line_echarts_points"}})]:a("p",[t._v("无测点数据")])],2)])},F=[],N=C(Y,w,F,!1,null,"af422c3a");const k=N.exports,j={name:"WarnDialog",mixins:["common"],components:{"warn-echarts":k},props:{datasource:{type:Object,default:()=>({})}},data(){return{visible:!1,selectItem:{},alarmCondition:[],judgeCondition:[],pointModalTitle:"",entityInfo:null,topicPointId:""}},watch:{},mounted(){this.initCode(),this.entityInfo=x()},methods:{initCode(){P({dictCode:"judgeCondition"}).then(e=>{this.judgeCondition=e.result.list})},showWarningDetail(e){if(this.entityInfo.topicName.includes("19478/1320966/1320969/1324731")||this.entityInfo.topicName.includes("19478/1320966/1320969/1364725")){console.warn("南彭岛无测点，暂时不弹窗");return}this.selectItem=e,this.pointModalTitle=`${e.parentCode?e.parentCode+" - ":""}${e.alarmName}`,this.visible=!0}}};var L=function(){var t=this,a=t._self._c;return a("a-modal",{staticClass:"blackModal",attrs:{visible:t.visible,title:t.pointModalTitle,footer:null,width:1e3},on:{cancel:function(i){t.visible=!1}}},[t.visible?a("warn-echarts",{ref:"linecharts",attrs:{entityInfo:t.entityInfo,selectItem:t.selectItem,judgeCondition:t.judgeCondition}}):t._e()],1)},M=[],S=C(j,L,M,!1,null,"88ceb8df");const B=S.exports;export{B as W};
